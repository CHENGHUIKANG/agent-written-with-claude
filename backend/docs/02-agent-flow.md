# Agent 执行流程文档

## 一、总体执行流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Agent 执行流程                                   │
└─────────────────────────────────────────────────────────────────────────┘

用户输入提示词
      │
      ▼
┌─────────────────────────┐
│   Agent 执行器         │
│                        │
│ 1. 构建工具列表        │  → 从 MySQL 读取 MCP/LLM 配置
│ 2. 准备调用参数        │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│   LLM 客户端           │
│                        │
│ • 调用大模型 (QwQ-32B)  │
│ • 传入: 用户提示 + 工具列表
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│   LLM 分析与决策       │
│                        │
│ 判断是否需要调用工具？  │
│                        │
│   ┌────────┐  ┌────────┐
│   │   否   │  │   是   │
│   └───┬────┘  └────┬───┘
│       │            │
│       ▼            ▼
│  直接返回     ┌────────────────┐
│  最终答案     │ Agent 执行器   │
│               │                │
│               │ 解析工具调用    │
│               │ 路由到对应工具  │
│               └────────┬───────┘
│                        │
│         ┌──────────────┼──────────────┐
│         │              │              │
│         ▼              ▼              ▼
│  ┌──────────┐   ┌──────────┐   ┌──────────┐
│  │ fastmcp  │   │  MCP     │   │  其他    │
│  │ 内置工具 │   │  外部工具 │   │  自定义  │
│  └────┬─────┘   └─────┬────┘   └─────┬────┘
│       │              │              │
│       └──────────────┼──────────────┘
│                      │
│              执行工具调用
│                      │
│              获取执行结果
│                      │
│                      ▼
│         ┌────────────────────────┐
│         │   将结果返回 LLM        │
│         │   LLM 继续思考/生成答案 │
│         └────────────────────────┘
│                      │
│         ┌────────────┴────────────┐
│         │                         │
│         ▼                         ▼
│   继续循环                 返回最终答案
```

## 二、详细执行步骤

### 步骤1：初始化
```
┌───────────────────────────────────────────────────────────────┐
│  1.1 加载用户配置                                               │
│      - 从 MySQL 读取用户的 LLM 配置                             │
│      - 从 MySQL 读取用户的 MCP 服务器配置                       │
│      - 从 MySQL 读取用户的内置工具配置                          │
│                                                               │
│  1.2 构建工具列表                                               │
│      - 加载 fastmcp 内置工具                                   │
│      - 连接外部 MCP 服务器，获取可用工具                        │
│      - 生成工具描述 (JSON Schema 格式)                         │
│                                                               │
│  1.3 初始化 LLM 客户端                                         │
│      - 根据配置创建 LLM 客户端实例                             │
│      - 设置模型参数 (temperature, max_tokens 等)              │
└───────────────────────────────────────────────────────────────┘
```

### 步骤2：接收用户输入
```
┌───────────────────────────────────────────────────────────────┐
│  2.1 接收前端发送的提示词                                        │
│      - 用户输入的文本或文件                                     │
│      - 可选的上下文信息                                         │
│                                                               │
│  2.2 构建消息历史                                               │
│      - 从 Redis 获取对话历史                                   │
│      - 或从 MySQL 获取完整对话记录                             │
│                                                               │
│  2.3 格式化输入                                                 │
│      - 将用户输入转换为 LLM 接受的消息格式                      │
│      - 添加系统提示词 (System Prompt)                          │
└───────────────────────────────────────────────────────────────┘
```

### 步骤3：LLM 决策
```
┌───────────────────────────────────────────────────────────────┐
│  3.1 调用 LLM API                                              │
│      - 传入消息历史                                             │
│      - 传入可用工具列表                                         │
│      - 设置 tool_choice="auto"                                  │
│                                                               │
│  3.2 LLM 分析并生成响应                                         │
│      - 分析任务意图                                             │
│      - 决定是否需要调用工具                                     │
│      - 如果需要，生成工具调用请求                               │
│                                                               │
│  3.3 解析 LLM 响应                                             │
│      - 检查是否有 tool_calls                                   │
│      - 获取工具名称和参数                                      │
│      - 获取对话内容 (如果有)                                    │
└───────────────────────────────────────────────────────────────┘
```

### 步骤4：工具执行 (如需要)
```
┌───────────────────────────────────────────────────────────────┐
│  4.1 工具路由                                                   │
│      - 根据工具名称确定工具类型：                                │
│        • 内置工具 → fastmcp 服务                                │
│        • 外部工具 → MCP 客户端                                  │
│        • 自定义工具 → 直接调用                                  │
│                                                               │
│  4.2 执行工具调用                                               │
│      • fastmcp 内置工具执行：                                    │
│        ┌───────────────────────────────────────────────────┐  │
│        │  - file_save(content, filepath)                   │  │
│        │  - file_read(filepath)                           │  │
│        │  - file_search(filepath, pattern)                │  │
│        │  - web_search(query)                             │  │
│        └───────────────────────────────────────────────────┘  │
│                                                               │
│      • MCP 外部工具执行：                                       │
│        ┌───────────────────────────────────────────────────┐  │
│        │  1. 从配置中获取 MCP 服务器连接参数                │  │
│        │  2. 建立 MCP 会话                                 │  │
│        │  3. 调用对应的 MCP 工具                            │  │
│        │  4. 接收工具执行结果                              │  │
│        │  5. 关闭 MCP 会话                                 │  │
│        └───────────────────────────────────────────────────┘  │
│                                                               │
│  4.3 格式化工具结果                                             │
│      - 将工具输出转换为 LLM 可理解的格式                        │
│      - 处理错误和异常情况                                      │
└───────────────────────────────────────────────────────────────┘
```

### 步骤5：循环执行
```
┌───────────────────────────────────────────────────────────────┐
│  5.1 将工具结果返回给 LLM                                        │
│      - 将工具执行结果作为新的消息发送给 LLM                     │
│      - 包含工具调用信息和结果                                   │
│                                                               │
│  5.2 LLM 继续思考                                               │
│      - 分析工具执行结果                                         │
│      - 判断是否需要更多工具调用                                 │
│      - 或生成最终答案                                           │
│                                                               │
│  5.3 循环或终止                                                 │
│      - 如果还有工具调用 → 返回步骤4                             │
│      - 如果没有工具调用 → 继续下一步                            │
└───────────────────────────────────────────────────────────────┘
```

### 步骤6：返回最终答案
```
┌───────────────────────────────────────────────────────────────┐
│  6.1 生成最终响应                                               │
│      - 提取 LLM 生成的最终文本                                 │
│      - 整理工具调用记录                                         │
│                                                               │
│  6.2 保存对话历史                                               │
│      - 将用户输入和最终响应保存到 Redis                        │
│      - 或保存到 MySQL conversations 表                        │
│                                                               │
│  6.3 返回前端                                                   │
│      - 返回最终答案                                           │
│      - 返回工具调用记录 (用于调试)                              │
└───────────────────────────────────────────────────────────────┘
```

## 三、消息格式示例

### LLM 请求格式
```json
{
  "model": "Qwen/QwQ-32B-Preview",
  "messages": [
    {
      "role": "system",
      "content": "你是一个智能助手，可以使用各种工具来帮助用户完成任务。"
    },
    {
      "role": "user",
      "content": "请帮我搜索关于人工智能的最新新闻"
    }
  ],
  "tools": [
    {
      "type": "function",
      "function": {
        "name": "web_search",
        "description": "搜索网络信息",
        "parameters": {
          "type": "object",
          "properties": {
            "query": {
              "type": "string",
              "description": "搜索关键词"
            }
          },
          "required": ["query"]
        }
      }
    }
  ],
  "tool_choice": "auto"
}
```

### LLM 响应格式 (包含工具调用)
```json
{
  "id": "chatcmpl-xxx",
  "object": "chat.completion",
  "created": 1234567890,
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "我来帮你搜索关于人工智能的最新新闻。",
        "tool_calls": [
          {
            "id": "call_abc123",
            "type": "function",
            "function": {
              "name": "web_search",
              "arguments": "{\"query\": \"人工智能 最新新闻 2025\"}"
            }
          }
        ]
      }
    }
  ]
}
```

### 工具执行结果返回 LLM
```json
{
  "model": "Qwen/QwQ-32B-Preview",
  "messages": [
    {
      "role": "user",
      "content": "请帮我搜索关于人工智能的最新新闻"
    },
    {
      "role": "assistant",
      "content": "我来帮你搜索关于人工智能的最新新闻。",
      "tool_calls": [
        {
          "id": "call_abc123",
          "type": "function",
          "function": {
            "name": "web_search",
            "arguments": "{\"query\": \"人工智能 最新新闻 2025\"}"
          }
        }
      ]
    },
    {
      "role": "tool",
      "content": "搜索结果：\n1. OpenAI 发布新模型 GPT-5\n2. 阿里推出 Qwen2.5 系列\n3. Claude Opus 4.5 更新...",
      "tool_call_id": "call_abc123"
    }
  ]
}
```

## 四、内置工具说明

### 1. file_save
```python
def file_save(content: str, filepath: str) -> str:
    """
    保存内容到指定文件

    参数:
        content: 要保存的文件内容
        filepath: 文件路径

    返回:
        操作结果消息
    """
```

### 2. file_read
```python
def file_read(filepath: str) -> str:
    """
    读取指定文件内容

    参数:
        filepath: 文件路径

    返回:
        文件内容
    """
```

### 3. file_search
```python
def file_search(filepath: str, pattern: str) -> list[str]:
    """
    在文件中搜索匹配的内容

    参数:
        filepath: 文件路径
        pattern: 搜索模式 (支持正则)

    返回:
        匹配的行列表
    """
```

### 4. web_search
```python
def web_search(query: str, num_results: int = 10) -> list[dict]:
    """
    搜索网络信息

    参数:
        query: 搜索关键词
        num_results: 返回结果数量

    返回:
        搜索结果列表
    """
```

## 五、错误处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        错误处理流程                              │
└─────────────────────────────────────────────────────────────────┘

工具执行失败
      │
      ▼
┌─────────────────────┐
│  捕获异常           │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  记录错误日志       │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  格式化错误信息     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  返回给 LLM         │
│  (包含错误详情)     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  LLM 尝试恢复       │
│  或向用户报告       │
└─────────────────────┘
```

## 六、性能优化建议

1. **工具调用缓存**
   - 对相同参数的工具调用结果进行缓存
   - 减少重复的 MCP 连接开销

2. **流式响应**
   - LLM 流式返回生成内容
   - 前端实时展示

3. **并发工具执行**
   - 如果 LLM 返回多个独立的工具调用
   - 可以并发执行这些工具

4. **连接池**
   - MCP 客户端使用连接池
   - Redis 使用连接池

5. **响应缓存**
   - 对常见问题的 LLM 响应进行缓存
   - 存储在 Redis 中
