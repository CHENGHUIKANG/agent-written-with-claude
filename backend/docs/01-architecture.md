# 系统架构设计文档

## 一、整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Vue 前端层                                │
│  ┌─────────┐  ┌──────────┐  ┌──────────────┐  ┌────────────────┐  │
│  │ 用户管理│  │ MCP配置  │  │ LLM配置      │  │   Agent对话     │  │
│  └─────────┘  └──────────┘  └──────────────┘  └────────────────┘  │
└───────────────────────────────┬───────────────────────────────────────┘
                                │ HTTP/WebSocket
┌───────────────────────────────▼───────────────────────────────────────┐
│                        FastAPI 后端层                                 │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                      认证中间件 (JWT)                            │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────────┐  │
│  │    用户模块      │  │    配置管理      │  │    Agent核心       │  │
│  │                  │  │                  │  │                    │  │
│  │  - 用户CRUD      │  │  - MCP配置CRUD   │  │  - Agent执行器     │  │
│  │  - 认证逻辑      │  │  - LLM配置CRUD   │  │  - 工具调用编排    │  │
│  └──────────────────┘  └─────────┬────────┘  └─────────┬──────────┘  │
│                                  │                     │              │
│                                  │                     │              │
│                                  ▼                     │              │
│                           ┌─────────────┐              │              │
│                           │    MySQL    │              │              │
│                           │             │              │              │
│                           │  - users    │              │              │
│                           │  - mcp_     │              │              │
│                           │    servers  │              │              │
│                           │  - llm_     │              │              │
│                           │    configs  │              │              │
│                           └─────────────┘              │              │
│                                  │                     │              │
│                                  │ 配置读取             │              │
│                                  │                     │              │
│                                  │         ┌───────────▼──────┐       │
│                                  │         │   LLM客户端       │       │
│                                  │         │                  │       │
│                                  │         │ - 调用LLM API    │       │
│                                  │         │ - 工具调用      │       │
│                                  │         │ - 流式响应      │       │
│                                  │         └─────────┬────────┘       │
│                                  │                   │                │
│                                  │                   ▼                │
│                                  │         ┌──────────────────┐       │
│                                  │         │  QwQ-32B (vLLM)  │       │
│                                  │         │  本地/云端部署    │       │
│                                  │         │  OpenAI兼容API   │       │
│                                  │         └──────────────────┘       │
│                                  │                   │                │
│                                  │                   │ 决策           │
│                                  │                   │ "调用工具X"    │
│                                  │                   │                │
│                                  │         ┌─────────▼────────┐       │
│                                  │         │   Agent执行器    │       │
│                                  │         │                 │       │
│                                  │         │ - 接收LLM决策   │       │
│                                  │         │ - 路由工具调用   │       │
│                                  │         │ - 返回执行结果   │       │
│                                  │         └─────────┬────────┘       │
│                                  │                   │                │
│                                  │                   │ 工具执行       │
│                                  │                   │                │
│                                  │                   ▼                │
│                                  │         ┌─────────────────────┐    │
│                                  │         │      工具层         │    │
│                                  │         │                     │    │
│                                  │         │  ┌───────────────┐  │    │
│                                  │         │  │ fastmcp服务   │  │    │
│                                  │         │  │ (内置工具)     │  │    │
│                                  │         │  │               │  │    │
│                                  │         │  │ - file_save   │  │    │
│                                  │         │  │ - file_read   │  │    │
│                                  │         │  │ - file_search │  │    │
│                                  │         │  │ - web_search  │  │    │
│                                  │         │  └───────────────┘  │    │
│                                  │         │                     │    │
│                                  │         │  ┌───────────────┐  │    │
│                                  │         │  │ MCP客户端管理 │  │    │
│                                  │         │  │ (外部工具)     │  │    │
│                                  │         │  │               │  │    │
│                                  │         │  │ - 连接外部MCP │  │    │
│                                  │         │  │ - 工具发现    │  │    │
│                                  │         │  │ - 工具调用    │  │    │
│                                  │         │  └───────┬───────┘  │    │
│                                  │         │          │          │    │
│                                  │         └──────────┼──────────┘    │
│                                  │                    │                │
│                                  │                    ▼                │
│                                  │         ┌──────────────────┐       │
│                                  │         │  外部MCP服务      │       │
│                                  │         │  (如：数据库、    │       │
│                                  │         │   文件系统、API) │       │
│                                  │         └──────────────────┘       │
│                                  │                                      │
│                                  │        ┌─────────────────┐         │
│                                  │        │     Redis       │         │
│                                  │        │                 │         │
│                                  │        │ - JWT令牌缓存    │         │
│                                  │        │ - 会话存储      │         │
│                                  │        │ - LLM响应缓存    │         │
│                                  │        └─────────────────┘         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 二、三层架构说明

### 第一层：决策层
```
┌──────────────────────────────────────────────────────────────────────┐
│                        决策层 (LLM)                                   │
│                                                                      │
│                     LLM 客户端                                       │
│                     - 接收用户提示                                   │
│                     - 分析任务意图                                   │
│                     - 决策是否调用工具                               │
│                     - 选择工具                                       │
│                     - 生成最终答案                                   │
└───────────────────────────────┬──────────────────────────────────────┘
                                │
                                │ 决策结果：调用工具 X
                                │
```

### 第二层：编排层
```
┌──────────────────────────────────────────────────────────────────────┐
│                        编排层 (Agent)                                 │
│                                                                      │
│                     Agent 执行器                                     │
│                     - 接收 LLM 决策                                  │
│                     - 路由到对应工具                                 │
│                     - 管理工具执行状态                               │
│                     - 汇总执行结果                                   │
└───────────────────────────────┬──────────────────────────────────────┘
                                │
                                │ 执行命令
                                │
```

### 第三层：执行层
```
┌──────────────────────────────────────────────────────────────────────┐
│                        执行层 (工具)                                   │
│                                                                      │
│  ┌──────────────────┐          ┌──────────────────┐                  │
│  │   fastmcp 服务   │          │   MCP 客户端     │                  │
│  │   (内置工具)     │          │   (外部工具)     │                  │
│  │                  │          │                  │                  │
│  │  - file_save     │          │  - 连接外部MCP   │                  │
│  │  - file_read     │          │  - 调用远程工具   │                  │
│  │  - file_search   │          │                  │                  │
│  │  - web_search    │          │                  │                  │
│  └──────────────────┘          └──────────────────┘                  │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

## 三、模块依赖关系

### 配置管理模块依赖
```
┌──────────────────┐
│   MCP配置CRUD    │
└────────┬─────────┘
         │ 读写
         ▼
┌──────────────────┐
│     MySQL        │  ← 存储MCP服务器配置信息
│                  │  - server_type (stdio/sse)
│   mcp_servers    │  - connection_params
│   - id           │  - status
│   - user_id      │  - created_at
│   - name         │
└──────────────────┘
```

### LLM客户端依赖
```
┌──────────────────┐
│   LLM客户端      │
└────────┬─────────┘
         │ 1. 从MySQL读取配置
         ▼
┌──────────────────┐
│     MySQL        │
│   llm_configs    │
│   - provider     │  (custom/local)
│   - model_name   │  (QwQ-32B)
│   - base_url     │  (http://localhost:8000/v1)
└──────────────────┘

         │ 2. 调用LLM API
         ▼
┌──────────────────────────┐
│   QwQ-32B (vLLM)         │
│   本地部署端点            │
│   http://localhost:8000  │
└──────────────────────────┘
```

### Redis作用
```
┌────────────────────────────────────────────────────────────────┐
│                        Redis 缓存层                            │
└────────────────────────────────────────────────────────────────┘

┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  JWT令牌缓存    │  │  用户会话存储    │  │  LLM响应缓存    │
│                 │  │                 │  │                 │
│  - token:black  │  │  - session:{id}  │  │  - llm:{prompt} │
│  - 30分钟过期   │  │  - 聊天历史      │  │  - 减少重复调用 │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

## 四、模块依赖表

| 模块 | 依赖 | 存储 |
|------|------|------|
| 用户模块 | Redis (会话) | MySQL (用户数据) |
| MCP配置 | 无 | MySQL (配置数据) |
| LLM配置 | 无 | MySQL (配置数据) |
| MCP客户端 | 外部MCP服务 | 无 |
| LLM客户端 | LLM API (本地/云端) | 无 |
| Agent执行器 | LLM客户端 + MCP客户端 + fastmcp | Redis (响应缓存) |

## 五、技术栈

### 后端技术栈
| 类别 | 技术 | 说明 |
|------|------|------|
| Web框架 | FastAPI | 高性能、异步支持 |
| ORM | SQLAlchemy | 数据库操作 |
| 数据库 | MySQL | 关系型数据库 |
| 缓存 | Redis | 会话、缓存 |
| 认证 | JWT | JSON Web Token |
| MCP | fastmcp + mcp SDK | 内部工具 + 外部连接 |
| LLM | OpenAI API | 支持自定义端点 |

### 前端技术栈
| 类别 | 技术 | 说明 |
|------|------|------|
| 框架 | Vue 3 | 渐进式框架 |
| 语言 | TypeScript | 类型安全 |
| UI组件库 | Element Plus / Ant Design Vue |
| 状态管理 | Pinia | Vue 3 官方推荐 |
| HTTP客户端 | Axios | HTTP 请求 |
